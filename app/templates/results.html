<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NephroScan ‚Äì Diagnostic Report</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Orbitron', sans-serif;
      background: #0f0f1a;
      color: #e0e0ff;
      margin: 0;
      padding: 30px;
    }

    .container {
      max-width: 960px;
      margin: auto;
      background: #1e1e2f;
      border-radius: 20px;
      box-shadow: 0 0 20px #00ffe7;
      padding: 30px;
    }

    h2, h3 {
      color: #00ffe7;
      text-align: center;
      margin-bottom: 20px;
      text-shadow: 0 0 5px #00fff2;
    }

    .image-box {
      border: 2px solid #00ffe7;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .image-box img {
      max-width: 100%;
      max-height: 500px;
      object-fit: contain;
    }

    .report-box {
      background: #18182d;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 30px;
      line-height: 1.6;
    }

    .report-box pre {
      white-space: pre-wrap;
      color: #e0ffe0;
    }

    .chat-section {
      background: #111;
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
    }

    #chatbox {
      background: rgba(255,255,255,0.05);
      height: 250px;
      overflow-y: auto;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
      font-family: monospace;
      white-space: pre-wrap;
    }

    #chatInput {
      width: 75%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #00ffe7;
      background: #1e1e2f;
      color: #fff;
    }

    button {
      background: linear-gradient(90deg, #00ffe7, #009fff);
      color: #000;
      padding: 10px 20px;
      font-weight: bold;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }

    button:hover {
      background: #00ffe7;
    }

    .map-container {
      margin-top: 20px;
      border: 2px solid #00ffe7;
      border-radius: 12px;
      overflow: hidden;
      display: none;
    }

    .map-container iframe {
      width: 100%;
      height: 320px;
      border: none;
    }

    .back-btn {
      margin-top: 20px;
      text-align: center;
    }

    .back-btn a {
      color: #00ffe7;
      text-decoration: none;
      font-weight: bold;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    li {
      margin-bottom: 10px;
      font-size: 1em;
    }

    .note {
      font-size: 0.9em;
      color: #b0b0ff;
      margin-top: 10px;
      text-align: center;
    }

    .warning {
      color: #ff4d4d;
      font-size: 1em;
      margin-top: 10px;
      text-shadow: 0 0 5px #ff4d4d;
    }

    .debug {
      font-size: 0.8em;
      color: #ffeb3b;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- PDF Button -->
    <a href="{{ url_for('routes.pdf_preview') }}">
      <button>üìÑ Preview & Download PDF</button>
    </a>

    <!-- Report Area -->
    <div id="pdfArea" style="position: relative;">
      <h2>üß† Nephrology Diagnostic Report</h2>

      <div class="image-box">
        {% if localized_image_url %}
          <img src="{{ url_for('static', filename=localized_image_url) }}" alt="Localized CT Image">
        {% else %}
          <p>No localized image available.</p>
        {% endif %}
        
      </div>
                <p class="note">Note: Red rectangles indicate detected regions (e.g., Top Right, Middle Left, Middle Down).</p>


      <div class="report-box">
        <h3>üìã Diagnosis Summary</h3>
        <pre>{{ report | safe }}</pre>

        <!-- Debug Info -->
        <p class="debug">[Debug] Label: {{ label }}, Regions: {{ regions }}</p>

        {% if label|lower != 'normal' %}
          {% if regions %}
            <h4>üìç Detected Regions:</h4>
            <ul>
              {% for region in regions %}
                <li>{{ region }}</li>
              {% endfor %}
            </ul>
            <p class="note">Note: Our model is 89% accurate. Blurry images or small abnormalities may affect results. Consult a nephrologist to confirm these locations.</p>
          {% else %}
            <h4>üìç Detected Regions:</h4>
            <p class="warning">‚ö†Ô∏è The model was unable to localize regions, possibly due to low image quality, inability to extract features, or model limitations (89% accuracy).</p>
            <p class="note">Please consult a nephrologist for a detailed review of your CT scan. Drink more water and reduce salty or oxalate-rich foods (e.g., nuts, tea) to lower risk.</p>
          {% endif %}
        {% endif %}
      </div>

      <p style="text-align: right; font-size: 12px;">üïí Generated on: {{ current_time }}</p>
    </div>

    <!-- Chat Section -->
    <div class="chat-section">
      <h3>üí¨ Ask NephroBot About Your Results</h3>
      <div id="chatbox">üß† Hello! I can explain cysts, tumors, kidney conditions, or suggest treatments.</div>
      <input type="text" id="chatInput" placeholder="Ask about your result...">
      <button onclick="sendMessage()">Send</button>

      <!-- Map & Specialist List -->
      <div id="mapContainer" class="map-container"></div>
    </div>

    <!-- Back Button -->
    <div class="back-btn">
      <a href="{{ url_for('routes.index') }}">‚Üê Back to Upload</a>
    </div>
  </div>

  <!-- PDF Script -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    const chatbox = document.getElementById("chatbox");
    const input = document.getElementById("chatInput");
    const mapContainer = document.getElementById("mapContainer");

    function sendMessage(msg = null) {
      const message = msg || input.value.trim();
      if (!message) return;

      chatbox.innerHTML += `\nYou: ${message}`;

      fetch("/chat", {
        method: "POST",
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: "message=" + encodeURIComponent(message)
      })
      .then(response => response.json())
      .then(data => {
        chatbox.innerHTML += `\nNephroBot: ${data.response.text}`;
        chatbox.scrollTop = chatbox.scrollHeight;

        if (data.response.map_url) {
          mapContainer.style.display = "block";
          mapContainer.innerHTML = `
            <iframe
              src="${data.response.map_url}"
              allowfullscreen
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade">
            </iframe>`;
        } else {
          mapContainer.style.display = "none";
        }
      });

      if (!msg) input.value = "";
    }

    const detectedLabel = "{{ label }}";
    if (detectedLabel && detectedLabel.toLowerCase() !== "normal") {
      const autoMessage = `What is a ${detectedLabel}?`;
      setTimeout(() => sendMessage(autoMessage), 1000);
    }

    function downloadPDF() {
      const element = document.getElementById('pdfArea');
      const opt = {
        margin: 0.5,
        filename: 'NephroScan_Report.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(element).save();
    }
  </script>
</body>
</html>